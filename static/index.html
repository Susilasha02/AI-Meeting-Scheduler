<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Timetable-Aware AI Scheduler</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --accent:#4f46e5; --muted:#6b7280;
    --success:#16a34a; --danger:#ef4444;
  }
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%); display:flex; align-items:center; justify-content:center; padding:48px;}
  .container{width:920px; max-width:95%;}
  .card{background:var(--card); border-radius:12px; box-shadow:0 8px 30px rgba(16,24,40,0.08); padding:28px;}
  header{display:flex; align-items:center; gap:16px; margin-bottom:20px;}
  .logo{width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#06b6d4); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:22px;}
  h1{margin:0; font-size:20px; color:#0f172a;}
  p.lead{margin:6px 0 0;color:var(--muted); font-size:13px;}
  .controls{display:flex; gap:12px; align-items:center;margin-bottom:18px;}
  .prompt{flex:1;}
  textarea#prompt{width:100%;min-height:54px;border-radius:8px;padding:12px;border:1px solid #e6e9ef; font-size:15px;resize:vertical;}
  .small{font-size:13px; color:var(--muted);}
  .btn{background:var(--accent); color:white;padding:10px 14px;border-radius:8px;border:0; cursor:pointer; font-weight:600;}
  .btn.secondary{background:#fff; color:var(--accent); border:1px solid #e6e9ef;}
  .row{display:flex; gap:12px; align-items:center; margin-top:8px;}
  .toggle { display:inline-flex; align-items:center; gap:10px; font-size:14px; color:var(--muted); }
  .switch{--w:44px; --h:24px; width:var(--w); height:var(--h); background:#e6e9ef;border-radius:999px; padding:3px; display:inline-flex; align-items:center; cursor:pointer;}
  .switch .knob{width:18px;height:18px;border-radius:999px;background:white; transition:transform .18s ease; box-shadow:0 2px 6px rgba(2,6,23,0.12);}
  .switch.on{background:linear-gradient(90deg,var(--accent),#06b6d4);}
  .switch.on .knob{transform:translateX(20px);}
  input.participants{width:380px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;}
  .suggestions{margin-top:20px;}
  .slot{border:1px solid #eef2ff; padding:14px;border-radius:10px; margin-bottom:12px; background:linear-gradient(180deg,#fff,#fbfdff);}
  .slot h4{margin:0; font-size:15px;}
  .slot .meta{color:var(--muted); font-size:13px;margin-top:6px;}
  .slot .actions{margin-top:10px; display:flex; gap:10px; align-items:center;}
  .link{color:var(--accent); text-decoration:none; font-weight:600;}
  .msg{padding:10px;border-radius:8px;background:#f1f5f9;color:#0f172a;}
  footer{margin-top:18px; font-size:12px; color:var(--muted);}
  @media (max-width:640px){
    .row{flex-direction:column;align-items:stretch;}
    input.participants{width:100%;}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card" role="main">
      <header>
        <div class="logo">TS</div>
        <div>
          <h1>Timetable-Aware AI Scheduler</h1>
          <p class="lead">Type natural language like “30 min today afternoon” or “45 min with raj@example.com tomorrow”.</p>
        </div>
      </header>

      <div class="controls">
        <div class="prompt" style="flex:1">
          <textarea id="prompt" placeholder='e.g. "30 min today afternoon"'>30 min meet today</textarea>
          <div class="row">
            <button class="btn" id="suggestBtn">Suggest</button>
            <button class="btn secondary" id="connectBtn" onclick="window.location='/auth/start?next=/ui/'">Connect Google</button>
            <div class="toggle" title="When ON the scheduler will only look for slots within today">
              <div id="todaySwitch" class="switch" onclick="toggleSwitch()"><div class="knob"></div></div>
              <span>Today only</span>
            </div>
          </div>
        </div>

        <div style="width:320px;">
          <div style="margin-bottom:8px" class="small">Participants (comma-separated emails)</div>
          <input id="participants" class="participants" placeholder="alice@example.com, bob@example.com" />
          <div style="margin-top:8px" class="small">Tip: adding emails will send invites to the participants.</div>
        </div>
      </div>

      <div id="messages"></div>

      <div class="suggestions" id="suggestions"></div>

      <footer>Made with ♥ — Scheduler prototype. Click Connect Google first if you haven't already.</footer>
    </div>
  </div>

<script>
let todayOnly = false;
function toggleSwitch(){
  const el = document.getElementById('todaySwitch');
  todayOnly = !todayOnly;
  if(todayOnly) el.classList.add('on'); else el.classList.remove('on');
}

document.getElementById('suggestBtn').addEventListener('click', async ()=>{
  const prompt = document.getElementById('prompt').value.trim();
  const participants = document.getElementById('participants').value.trim();
  if(!prompt){ showMessage('Please write a prompt'); return; }
  showMessage('Searching for best slots...');
  try{
    const res = await fetch('/suggest', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt, today_only: todayOnly, attendees: participants ? participants.split(',').map(s=>s.trim()): ["primary"]})
    });
    if(!res.ok){ const t = await res.text(); showMessage('Error: '+t); return; }
    const data = await res.json();
    renderSuggestions(data);
  }catch(err){
    showMessage('Network error: '+err.message);
  }
});

function showMessage(msg){
  document.getElementById('messages').innerHTML = `<div class="msg">${msg}</div>`;
}

function renderSuggestions(list){
  document.getElementById('messages').innerHTML = '';
  const box = document.getElementById('suggestions');
  if(!list || !list.length){ box.innerHTML = '<div class="msg">No slots found.</div>'; return; }
  box.innerHTML = '';
  window.__SUGGS = list;
  list.forEach((s, idx)=>{
    const el = document.createElement('div');
    el.className = 'slot';
    el.innerHTML = `
      <h4>${s.human}</h4>
      <div class="meta">Score: ${s.score} · ${s.explanation.readable}</div>
      <div class="actions">
        <button class="btn" onclick='book(${idx})'>Book</button>
        <a class="link" href="#" onclick="openInCalendar(${idx});return false;">Open in Calendar</a>
      </div>
    `;
    el.dataset.index = idx;
    box.appendChild(el);
  });
}

function openInCalendar(idx){
  const s = (window.__SUGGS || [])[idx];
  if(!s) return;
  // try to build calendar link — fallback: user will get event link after booking
  alert('Please Book; the event link will appear after booking.');
}

async function book(idx){
  const suggestions = window.__SUGGS || [];
  const choice = suggestions[idx];
  if(!choice){ showMessage('Nothing to book'); return; }
  showMessage('Booking...');
  const participants = document.getElementById('participants').value.trim();
  try{
    const attendees = participants ? participants.split(',').map(s=>s.trim()) : [];
    const res = await fetch('/book', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        start: choice.start,
        end: choice.end,
        attendees: attendees,
        subject: "Timetable-Aware Meeting",
        why: choice.explanation.readable,
        time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'
      })
    });
    const data = await res.json();
    if(res.ok){
      showMessage('Booked! Opening calendar...');
      if(data.htmlLink) window.open(data.htmlLink, '_blank');
    } else {
      showMessage('Booking error: '+(data.error || JSON.stringify(data)));
    }
  }catch(err){
    showMessage('Network or server error: '+err.message);
  }
}
</script>
</body>
</html>
